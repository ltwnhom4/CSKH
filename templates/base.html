<!DOCTYPE html>
{% load static %}
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Punky Spa{% endblock %}</title>

    <!-- ğŸŒ¸ LiÃªn káº¿t CSS -->
    <link rel="stylesheet" href="{% static 'trangchu/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<!-- ğŸ¾ Hiá»‡u á»©ng chÃ¢n mÃ¨o rÆ¡i -->
<div class="paw-fall"></div>
<script>
  const pawFallContainer = document.querySelector(".paw-fall");
  const pawSrc = "{% static 'trangchu/chanmeo.png' %}";
  function createPaw() {
    const paw = document.createElement("img");
    paw.src = pawSrc;
    paw.classList.add("paw-item");
    paw.style.left = Math.random() * 100 + "vw";
    paw.style.width = 25 + Math.random() * 20 + "px";
    paw.style.animationDuration = 5 + Math.random() * 4 + "s";
    paw.style.opacity = 0.6 + Math.random() * 0.4;
    pawFallContainer.appendChild(paw);
    setTimeout(() => paw.remove(), 9000);
  }
  setInterval(createPaw, 500);
</script>

<body>

    <!-- ğŸŒ¸ THANH TRÃŠN CÃ™NG -->
    <div class="topbar">
        <div class="topbar-left">
            <i class="fa fa-calendar"></i>
            <strong>Giá» lÃ m viá»‡c:</strong> Tá»« 09h00 Ä‘áº¿n 21h00
        </div>

        <div class="right">
            {% if user.is_authenticated %}
            <!-- ğŸ”” Náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p -->
            <div class="notify-box">
                <span class="notify-icon">ğŸ””</span>
                <span class="badge">{{ so_thong_bao_chua_doc }}</span>
                <div class="notify-content">
                    <div class="notify-list">
                        {% for tb in thong_baos_moi %}
                            <a href="{% url 'TB:xem_thong_bao' tb.id %}"
                               class="notify-item {% if not tb.da_doc %}chua-doc{% endif %}"
                               style="display:block; text-decoration:none; color:#333; padding:8px 10px; border-radius:8px; margin-bottom:5px; transition:0.3s;">
                                <div style="font-weight:600; color:#e75480;">
                                    {% if not tb.da_doc %}ğŸ”” {% endif %}{{ tb.tieu_de }}
                                </div>
                                <small style="color:#777;">{{ tb.ngay_tao|date:"d/m/Y H:i" }}</small>
                            </a>
                        {% empty %}
                            <p style="text-align:center;">KhÃ´ng cÃ³ thÃ´ng bÃ¡o má»›i.</p>
                        {% endfor %}
                    </div>
                    <a href="{% url 'TB:trang_thong_bao' %}" class="view-all">Xem táº¥t cáº£</a>
                </div>
            </div>

            <!-- MENU TÃ€I KHOáº¢N -->
            <div class="user-menu">
                <button class="user-btn">
                    <i class="fa fa-user"></i> {{ user.username }}
                    <i class="fa fa-caret-down"></i>
                </button>
                <div class="dropdown-menu">
                  {% if request.user.is_staff and not request.user.is_superuser %}
                    <a href="{% url 'thong_tin_nhanvien' %}"><i class="fa fa-user-tie"></i> TÃ i khoáº£n</a>
                    <a href="/admin/" class="dropdown-item"><i class="fa fa-tools"></i> Quáº£n lÃ½</a>
                    <a href="{% url 'xoa_tai_khoan' %}" class="delete-account"><i class="fa fa-trash"></i> KhÃ³a tÃ i khoáº£n</a>
                    <a href="{% url 'dangxuat' %}" class="dropdown-item"><i class="fa fa-sign-out-alt"></i> ÄÄƒng xuáº¥t</a>

                  {% elif not request.user.is_staff %}
                    <a href="{% url 'thongtintaikhoan' %}"><i class="fa fa-star"></i> TÃ i khoáº£n</a>
                    <a href="{% url 'lich_hen_sap_toi' %}"><i class="fa fa-calendar"></i> Lá»‹ch háº¹n</a>
                    <a href="{% url 'xem_tich_diem' %}" class="dropdown-item"> <i class="fa fa-star"></i> Äiá»ƒm tÃ­ch lÅ©y</a>
                    <a href="{% url 'danh_sach_khieu_nai' %}"><i class="fa fa-comments"></i> Khiáº¿u náº¡i</a>
                    <a href="{% url 'xoa_tai_khoan' %}" class="delete-account"><i class="fa fa-trash"></i> KhÃ³a tÃ i khoáº£n</a>
                    <a href="{% url 'dangxuat' %}"><i class="fa fa-sign-out-alt"></i> ÄÄƒng xuáº¥t</a>
                  {% endif %}

                  {% if user.is_superuser %}
                    <a href="/admin/" class="dropdown-item"><i class="fa fa-tools"></i> Quáº£n lÃ½</a>
                    <a href="{% url 'dangxuat' %}" class="dropdown-item"><i class="fa fa-sign-out-alt"></i> ÄÄƒng xuáº¥t</a>
                  {% endif %}
                </div>
            </div>

            {% else %}
            <!-- ğŸ”¹ Náº¿u chÆ°a Ä‘Äƒng nháº­p -->
            <div class="notify-box">
                <span class="notify-icon">ğŸ””<span class="notify-count">{{ thong_baos_moi|length }}</span></span>
                <div class="notify-content">
                    <div style="text-align:center; padding:15px;">
                        <img src="{% static 'trangchu/notify-cat .png' %}" alt="MÃ¨o dá»… thÆ°Æ¡ng" class="notify-image">
                        <p>ÄÄƒng nháº­p Ä‘á»ƒ xem thÃ´ng bÃ¡o</p>
                        <a href="{% url 'dangnhap' %}" class="btn">ÄÄƒng nháº­p</a>
                        <a href="{% url 'dangky' %}" class="btn">ÄÄƒng kÃ½</a>
                    </div>
                </div>
            </div>
            <a href="{% url 'dangnhap' %}">ÄÄƒng nháº­p</a> |
            <a href="{% url 'dangky' %}">ÄÄƒng kÃ½</a>
            {% endif %}
        </div>
    </div>

    <!-- ğŸŒ¸ HEADER CHÃNH -->
    <header class="navbar">
        <div class="logo">
            <img src="{% static 'trangchu/logo.png' %}" alt="Logo Punky Spa">
            <h1><span class="pink">Punky</span> Spa</h1>
        </div>

        <nav>
            <a href="{% url 'home' %}" class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">Trang chá»§</a>
            <a href="{% url 'danh_sach_dich_vu' %}" class="{% if request.resolver_match.url_name == 'danh_sach_dich_vu' %}active{% endif %}">Dá»‹ch vá»¥</a>
            <a href="{% url 'TB:danh_sach_khuyen_mai' %}" class="nav-link {% if request.resolver_match.url_name == 'danh_sach_khuyen_mai' %}active{% endif %}">Khuyáº¿n mÃ£i</a>
            <a href="{% url 'lien_he' %}" class="{% if request.resolver_match.url_name == 'lien_he' %}active{% endif %}">LiÃªn há»‡</a>
            <a href="{% url 'quan_ly_tich_diem' %}"  class="{% if request.resolver_match.url_name == 'quan_ly_tich_diem' %}active{% endif %}"  {% if request.user.is_staff or request.user.is_superuser %}{% else %}style="display:none"{% endif %}> Quáº£n lÃ½ tÃ­ch Ä‘iá»ƒm </a>
        </nav>

        <form class="search" method="get" action="{% url 'danh_sach_dich_vu' %}">
            <input type="text" name="q" placeholder="TÃ¬m kiáº¿m..." value="{{ request.GET.q }}">
            <button type="submit">ğŸ”</button>
        </form>

    </header>

    <!-- ğŸŒ¸ KHá»I Ná»˜I DUNG CHO TRANG CON -->
    {% block content %}{% endblock %}

    <!-- ğŸŒ¸ FOOTER -->
{% if request.resolver_match and request.resolver_match.url_name != 'dangnhap' and request.resolver_match.url_name != 'dangky' and request.resolver_match.url_name != 'quenmatkhau' %}
<footer class="footer">
  <div class="footer-container">
      <div class="footer-column">
          <h4>LiÃªn láº¡c</h4>
          <p>Hotline: 1900 6750</p>
          <p>Äá»‹a chá»‰: 627 NgÃ´ Quyá»n, An Háº£i Báº¯c,<br>ÄÃ  Náºµng, Viá»‡t Nam</p>
      </div>
      <div class="footer-column">
          <h4>ChÃ­nh sÃ¡ch</h4>
          <p>ChÃ­nh sÃ¡ch báº£o máº­t</p>
          <p>Quy Ä‘á»‹nh sá»­ dá»¥ng</p>
      </div>
      <div class="footer-column">
          <h4>Tá»•ng Ä‘Ã i há»— trá»£</h4>
          <p>TÆ° váº¥n dá»‹ch vá»¥: 1800 6750</p>
          <p>Há»— trá»£ sá»­ dá»¥ng: 1900 6750</p>
          <p>Email: punkyspa@gmail.vn</p>
          <p>Tá»« 7h00 â€“ 21h00 cÃ¡c ngÃ y tá»« thá»© 2 Ä‘áº¿n Chá»§ nháº­t.</p>
      </div>
  </div>
</footer>
{% endif %}

    <!-- ğŸŒ¸ NÃºt gá»i vÃ  Chat -->
    <div class="floating-icons">
        <a href="tel:19006750" class="phone-icon" title="Gá»i ngay Punky Spa">
            <i class="fa fa-phone"></i>
        </a>
        <!-- ğŸ’— NÃºt Chat theo loáº¡i tÃ i khoáº£n -->
        {% if not user.is_authenticated %}
            <!-- KHÃCH CHÆ¯A ÄÄ‚NG NHáº¬P -->
            <a href="{% url 'chatbox' %}" class="chat-floating-btn">
                <span id="chat-badge" class="badge" style="display:none;">0</span>
                <img class="chat-logo" src="{% static 'trangchu/logo.png' %}" alt="Chat">
            </a>

        {% else %}
            {% if user.khachhang %}
                <!-- KHÃCH HÃ€NG ÄÄ‚NG NHáº¬P -->
                <a href="{% url 'chatbox' %}" class="chat-floating-btn">
                    <span id="chat-badge" class="badge customer-badge">0</span>
                    <img class="chat-logo" src="{% static 'trangchu/logo.png' %}" alt="Chat">
                </a>

            {% elif user.is_staff or user.nhanvien %}
                <!-- ADMIN & NHÃ‚N VIÃŠN -->
                <a href="{% url 'danh_sach_khach' %}" class="chat-floating-btn">
                    <span id="admin-chat-badge" class="badge admin-badge">0</span>
                    <img class="chat-logo" src="{% static 'trangchu/logo.png' %}" alt="Chat">
                </a>
            {% endif %}
        {% endif %}
    </div>

<script>

    document.addEventListener("DOMContentLoaded", function() {
      // ğŸŒ¸ Dropdown tÃ i khoáº£n
      const userBtns = document.querySelectorAll(".user-btn");
      const dropdowns = document.querySelectorAll(".dropdown-menu");

      userBtns.forEach(btn => {
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          dropdowns.forEach(menu => menu.style.display = "none");
          const menu = btn.nextElementSibling;
          menu.style.display = menu.style.display === "block" ? "none" : "block";
        });
      });

      document.addEventListener("click", () => {
        dropdowns.forEach(menu => menu.style.display = "none");
      });


    });


function updateBadge() {
    fetch("/chat/get-unread-count/")
        .then(res => res.json())
        .then(data => {
            let badge = document.getElementById("chat-badge");
            if (data.count > 0) {
                badge.innerText = data.count;
                badge.style.display = "flex";
            } else {
                badge.style.display = "none";
            }
        });
}

setInterval(updateBadge, 2000);
updateBadge();

    // === Badge cho ADMIN & NHÃ‚N VIÃŠN ===
function updateAdminBadge() {
    fetch("/chat/get-unread-customers/")
        .then(res => res.json())
        .then(data => {
            let badge = document.getElementById("admin-chat-badge");
            if (badge) {
                if (data.count > 0) {
                    badge.innerText = data.count;
                    badge.style.display = "flex";
                } else {
                    badge.style.display = "none";
                }
            }
        });
}
setInterval(updateAdminBadge, 2000);
updateAdminBadge();
    </script>



</body>
</html>